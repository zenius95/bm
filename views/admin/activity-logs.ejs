<div class="space-y-8">
    <div>
        <h1 class="text-3xl font-bold text-white">Nhật ký hoạt động</h1>
        <p class="mt-1 text-gray-400">Theo dõi tất cả các hoạt động quan trọng trên hệ thống.</p>
    </div>

    <div class="flex flex-col md:flex-row items-center justify-between gap-4">
        <form method="GET" action="/admin/activity-logs" class="flex flex-col md:flex-row items-stretch md:items-center gap-3">
            <input type="text" name="searchUser" class="form-input" placeholder="Tìm theo Username..." value="<%= currentQuery.searchUser || '' %>">
            <input type="text" name="searchDetails" class="form-input" placeholder="Tìm trong chi tiết..." value="<%= currentQuery.searchDetails || '' %>">
            
            <select name="searchAction" class="form-select">
                <option value="">-- Lọc theo hành động --</option>
                <% Object.entries(actionLabels).sort(([, a], [, b]) => a.label.localeCompare(b.label)).forEach(([key, { label }]) => { %>
                    <option value="<%= key %>" <%= currentQuery.searchAction === key ? 'selected' : '' %>><%= label %></option>
                <% }); %>
            </select>

            <select name="searchContext" class="form-select">
                <option value="">-- Lọc theo ngữ cảnh --</option>
                <option value="Admin" <%= currentQuery.searchContext === 'Admin' ? 'selected' : '' %>>Admin</option>
                <option value="Client" <%= currentQuery.searchContext === 'Client' ? 'selected' : '' %>>Client</option>
            </select>
            
            <div class="flex items-center gap-2">
                 <button type="submit" class="w-full md:w-auto px-4 py-2.5 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold text-sm text-white transition whitespace-nowrap">Lọc</button>
                 <a href="/admin/activity-logs" class="w-full md:w-auto text-center px-4 py-2.5 bg-gray-700/50 hover:bg-gray-600/50 rounded-lg font-semibold text-sm text-gray-300 transition whitespace-nowrap">Reset</a>
            </div>
        </form>
        <div>
            <button id="hardDeleteSelectedBtn" disabled class="inline-flex items-center px-4 py-2 bg-red-600/80 border border-red-500 rounded-md font-semibold text-sm text-white hover:bg-red-600 transition disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="ri-delete-bin-fill mr-2"></i> Xóa mục đã chọn
            </button>
        </div>
    </div>

    <% if (pagination.totalPages > 1) { %>
        <div id="select-all-banner" class="hidden bg-blue-500/20 border border-blue-500/30 text-blue-300 px-4 py-3 rounded-lg text-sm" role="alert">
            Tất cả <strong id="items-on-page-count"></strong> mục trên trang này đã được chọn.
            <a href="#" id="select-all-matching-items" class="font-bold underline hover:text-white">Chọn tất cả <%= pagination.totalItems %> mục khớp với tìm kiếm này.</a>
        </div>
        <div id="clear-selection-banner" class="hidden bg-blue-500/20 border border-blue-500/30 text-blue-300 px-4 py-3 rounded-lg text-sm" role="alert">
            Tất cả <strong><%= pagination.totalItems %></strong> mục đã được chọn.
            <a href="#" id="clear-selection" class="font-bold underline hover:text-white">Bỏ chọn.</a>
        </div>
    <% } %>

    <div class="bg-white/5 backdrop-blur-lg border border-white/10 rounded-xl overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-300">
                <thead class="text-xs text-gray-400 uppercase bg-white/5">
                     <tr>
                         <th scope="col" class="p-4"><input type="checkbox" id="selectAllCheckbox" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-600 focus:ring-2"></th>
                        <th scope="col" class="px-6 py-3">Thời gian</th>
                        <th scope="col" class="px-6 py-3">Người dùng</th>
                        <th scope="col" class="px-6 py-3">Hành động</th>
                        <th scope="col" class="px-6 py-3">Chi tiết</th>
                        <th scope="col" class="px-6 py-3">Ngữ cảnh</th>
                         <th scope="col" class="px-6 py-3">Địa chỉ IP</th>
                     </tr>
                </thead>
                <tbody>
                    <% if (logs && logs.length > 0) { %>
                        <% logs.forEach(log => { %>
                             <tr id="log-row-<%= log._id %>" class="border-b border-white/10 hover:bg-white/5 transition-colors duration-200">
                                <td class="p-4"><input type="checkbox" value="<%= log._id %>" class="item-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-600 focus:ring-2"></td>
                                <td class="px-6 py-4 text-gray-400 whitespace-nowrap"><%= new Date(log.createdAt).toLocaleString('vi-VN') %></td>
                                <td class="px-6 py-4 font-medium text-white"><%= log.user ? log.user.username : 'N/A' %></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <% const actionInfo = actionLabels[log.action] || { label: log.action, color: 'bg-gray-700 text-gray-300' }; %>
                                    <span class="px-2.5 py-1 text-xs font-semibold rounded-full <%= actionInfo.color %>">
                                        <%= actionInfo.label %>
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-gray-300"><%= log.details %></td>
                                <td class="px-6 py-4">
                                    <span class="font-semibold <%= log.context === 'Admin' ? 'text-purple-400' : 'text-cyan-400' %>">
                                        <%= log.context %>
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-gray-400 font-mono"><%= log.ipAddress %></td>
                                </tr>
                        <% }); %>
                    <% } else { %>
                        <tr>
                            <td colspan="7" class="text-center py-16 px-6">
                                <i class="ri-file-search-line text-6xl text-gray-700"></i>
                                <h4 class="mt-4 text-xl font-semibold text-white">Không tìm thấy nhật ký nào</h4>
                                <p class="mt-2 text-gray-400">Hãy thử thay đổi bộ lọc hoặc đợi hoạt động mới.</p>
                            </td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <%- include('../partials/_pagination.ejs', { pagination, currentQuery }) %>
</div>

<script>
    document.body.dataset.currentQuery = JSON.stringify(<%- JSON.stringify(currentQuery) %>);
    document.body.dataset.totalItems = "<%= pagination.totalItems %>";
</script>
<script src="/js/admin/activity-logs.js"></script>