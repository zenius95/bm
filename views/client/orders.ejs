<div class="space-y-8">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-white">Lịch Sử Đơn Hàng</h1>
            <p class="mt-1 text-gray-400">Theo dõi tất cả các đơn hàng Bro đã tạo.</p>
        </div>
        <a href="/create-order" class="inline-flex items-center justify-center px-5 py-2.5 bg-blue-600 border border-transparent rounded-md font-semibold text-white hover:bg-blue-700 transition-transform duration-200 hover:scale-105">
            <i class="ri-add-line -ml-1 mr-2"></i>
            <span>Tạo Đơn Hàng Mới</span>
        </a>
    </div>

    <% if (orders && orders.length > 0) { %>
        <div class="space-y-4">
            <% orders.forEach(order => { %>
                <a href="/orders/<%= order._id %>" id="order-card-<%= order._id %>" class="block bg-white/5 backdrop-blur-lg border border-white/10 rounded-xl p-5 hover:border-blue-500/50 hover:bg-white/10 transition-all duration-300 group">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3">
                                <% 
                                    let statusConfig = { text: 'Pending', icon: 'ri-time-line', color: 'gray' };
                                    if (order.status === 'processing') statusConfig = { text: 'Processing', icon: 'ri-loader-4-line animate-spin', color: 'yellow' };
                                    if (order.status === 'completed') statusConfig = { text: 'Completed', icon: 'ri-checkbox-circle-line', color: 'green' };
                                    if (order.status === 'failed') statusConfig = { text: 'Failed', icon: 'ri-close-circle-line', color: 'red' };
                                %>
                                <span id="status-badge-<%= order._id %>" class="px-2.5 py-1 text-xs font-semibold rounded-full bg-<%= statusConfig.color %>-500/20 text-<%= statusConfig.color %>-300"><%= statusConfig.text %></span>
                                <p class="font-mono text-sm text-white group-hover:text-blue-300 transition-colors">ID: <%= order._id %></p>
                            </div>
                            <p class="text-xs text-gray-400 mt-2"><%= new Date(order.createdAt).toLocaleString('vi-VN') %></p>
                        </div>
                        
                        <div class="flex items-center justify-around gap-3 mr-6">
                            <div class="flex items-center text-left p-1 px-2 rounded-lg bg-gray-800/50">
                                <div class="flex items-center justify-start gap-2 w-[100px]" title="Tổng số lượng items">
                                    <i class="ri-stack-fill text-sky-400"></i>
                                    <p class="font-bold text-white text-sm"><%= order.items.length %></p>
                                </div>
                            </div>
                            <div class="flex items-center text-left p-1 px-2 rounded-lg bg-gray-800/50">
                                <div class="flex items-center justify-start gap-2 w-[100px]" title="Items thành công">
                                    <i class="ri-checkbox-circle-fill text-green-400"></i>
                                    <p class="font-bold item-completed-count text-white text-sm"><%= order.completedItems %></p>
                                </div>
                            </div>
                            <div class="flex items-center text-left p-1 px-2 rounded-lg bg-gray-800/50">
                                <div class="flex items-center justify-start gap-2 w-[100px]" title="Items thất bại">
                                    <i class="ri-close-circle-fill text-red-400"></i>
                                    <p class="font-bold item-failed-count text-white text-sm"><%= order.failedItems %></p>
                                </div>
                                <% 
                                    const pendingItems = order.items.length - order.completedItems - order.failedItems;
                                    if (pendingItems > 0) {
                                %>
                                <div class="flex items-center justify-center gap-2" title="Items đang chờ">
                                    <i class="ri-time-line text-gray-400"></i>
                                    <p class="font-bold text-white"><%= pendingItems %></p>
                                </div>
                                <% } %>
                            </div>
                        </div>

                        <div class="text-right" style="width: 200px;">
                            <p class="text-xs text-gray-400">Tổng chi phí</p>
                            <p class="text-lg font-bold font-mono text-yellow-400"><%= order.totalCost.toLocaleString('vi-VN') %>đ</p>
                        </div>
                    </div>
                </a>
            <% }); %>
        </div>
    <% } else { %>
        <div class="text-center py-20 px-6 bg-white/5 backdrop-blur-lg border border-dashed border-white/10 rounded-xl">
            <i class="ri-file-search-line text-6xl text-gray-700"></i>
            <h4 class="mt-4 text-xl font-semibold text-white">Bro chưa có đơn hàng nào</h4>
            <p class="mt-2 text-gray-400">Hãy bắt đầu bằng cách tạo đơn hàng đầu tiên của Bro!</p>
        </div>
    <% } %>
    
    <% if (pagination.totalPages > 1) { %>
    <nav class="flex justify-center">
        <ul class="inline-flex items-center -space-x-px">
            <% for(let i = 1; i <= pagination.totalPages; i++) { %>
                <li>
                    <a href="?page=<%= i %>" class="px-3 py-2 leading-tight transition-colors duration-200 <%= i === pagination.currentPage ? 'bg-blue-600 text-white border-blue-600' : 'bg-gray-800 text-gray-400 border-gray-700 hover:bg-gray-700 hover:text-white' %> <%= i === 1 ? 'rounded-l-lg' : '' %> <%= i === pagination.totalPages ? 'rounded-r-lg' : '' %>"><%= i %></a>
                </li>
             <% } %>
        </ul>
    </nav>
    <% } %>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const socket = io();

    socket.on('connect', () => {
        console.log('Connected to server for real-time order updates.');
    });

    socket.on('order:update', (data) => {
        const { id, status } = data;
        const statusBadge = document.getElementById(`status-badge-${id}`);
        if (!statusBadge) return;

        let statusConfig = { text: 'Pending', color: 'gray' };
        if (status === 'processing') statusConfig = { text: 'Processing', color: 'yellow' };
        if (status === 'completed') statusConfig = { text: 'Completed', color: 'green' };
        if (status === 'failed') statusConfig = { text: 'Failed', color: 'red' };

        statusBadge.textContent = statusConfig.text;
        statusBadge.className = `px-2.5 py-1 text-xs font-semibold rounded-full bg-${statusConfig.color}-500/20 text-${statusConfig.color}-300`;
    });

    socket.on('order:item_update', (data) => {
        const { id, completedItems, failedItems } = data;
        const orderCard = document.getElementById(`order-card-${id}`);
        if (!orderCard) return;

        const completedEl = orderCard.querySelector('.item-completed-count');
        const failedEl = orderCard.querySelector('.item-failed-count');

        if (completedEl) completedEl.textContent = completedItems;
        if (failedEl) failedEl.textContent = failedItems;
    });
});
</script>
